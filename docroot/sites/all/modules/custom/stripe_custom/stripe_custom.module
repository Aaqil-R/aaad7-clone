<?php
//Source from:  https://github.com/stripe/stripe-php
require('init.php');

function stripe_custom_init(){

}

function stripe_custom_webform_submission_insert($node, $submission){
	//TODO : Find a way to create the ID dynamically when creating a subscription plan
	$val = create_plan(120 , "id6" , "myplan");
	if($val == 0){
		//The plan is created Successfully. Subscribe the user to the plan here.
		//TODO : Create the subscriber here
	}
	else{
		//TODO : Update the DB with the error log.
		dpm("I am coming here");
	}
	//TODO : create the card details from the webfrom submission
	//creating a card
	$card = array(
		    	"number" => "4242424242424242",
		    	"exp_month" => 11,
		    	"exp_year" => 2016,
		   		"cvc" => "314"
		  	);

	//creating a subscriber
	//$test = create_subscriber('id6','amalan@test.com',$card);
	//dpm($test);

	$var = create_onetime_patment($card,500);
	dpm($var);
	
}


function create_subscriber($plan , $email , $card){
	try {
		\Stripe\Stripe::setApiKey(get_api());

		$token = \Stripe\Token::create(array(
		  "card" => $card,
		));

		$customer = \Stripe\Customer::create(array(
		  "source" => $token,
		  "plan" => $plan,
		  "email" => $email)
		);
		return 0;
	} catch(\Stripe\Error\Card $e) {
		return -1;
	} catch (\Stripe\Error\RateLimit $e) {
		return -1;
	} catch (\Stripe\Error\InvalidRequest $e) {
		return -1;
	} catch (\Stripe\Error\Authentication $e) {
		return -1;
	} catch (\Stripe\Error\ApiConnection $e) {
		return -1;
	} catch (\Stripe\Error\Base $e) {
		return -1;
	} catch (Exception $e) {
		return -1;
	}
}

function create_plan($amount , $id , $name){
	//TODO : When creating a new plan the amount must come from the webform submission
	try {
		//creating a new plan
		\Stripe\Stripe::setApiKey(get_api());

		$test = \Stripe\Plan::create(array(
		  "amount" => $amount,
		  "interval" => "month",
		  "name" => $name,
		  "currency" => "usd",
		  "id" => $id)
		);
		return 0;
	} catch(\Stripe\Error\Card $e) {
		return -1;
	} catch (\Stripe\Error\RateLimit $e) {
		return -1;
	} catch (\Stripe\Error\InvalidRequest $e) {
		return -1;
	} catch (\Stripe\Error\Authentication $e) {
		return -1;
	} catch (\Stripe\Error\ApiConnection $e) {
		return -1;
	} catch (\Stripe\Error\Base $e) {
		return -1;
	} catch (Exception $e) {
		return -1;
	}
}

function create_onetime_patment($card,$amount){
	try {
		//defining the api key 
		\Stripe\Stripe::setApiKey(get_api());

		//defining the charge details for one time payments
		$charge = \Stripe\Charge::create(array('card' => $card, 
												'amount' => $amount, 
												'currency' => 'usd'));
		echo $charge;
		return 0;
	} catch(\Stripe\Error\Card $e) {
		return -1;
	} catch (\Stripe\Error\RateLimit $e) {
		return -1;
	} catch (\Stripe\Error\InvalidRequest $e) {
		return -1;
	} catch (\Stripe\Error\Authentication $e) {
		return -1;
	} catch (\Stripe\Error\ApiConnection $e) {
		return -1;
	} catch (\Stripe\Error\Base $e) {
		return -1;
	} catch (Exception $e) {
		return -1;
	}
}

function stripe_custom_webform_submission_presave($node, $submission){
	if($contenttype == 'donations'){
		foreach ($node->webform['components'] as $key => $field) 
		{
			switch ($field['form_key']) 
			{
				case 'firstname':
					$firstname = $submission->data[$key][0];
				break;
				case 'amount':
					$amount = $submission->data[$key][0];
				break;
			}
		}

		//updating it with new values
		foreach ($node->webform['components'] as $key => $field) 
		{
			switch ($field['form_key']) 
			{
				case 'firstname':
					$submission->data[$key][0] = 'Testing name';
				break;
				case 'amount':
					//masking the number
					$number = maskstring($submission->data[$key][0]);
					$submission->data[$key][0] = $number;
				break;
			}
		}
	}
}

function maskstring($number){
	$count = strlen($number);
	for( $i=0; $i<$count-4 ; $i++){
		$number[$i] = 'X';
	}
	return $number;
}

//not calling this at the moment.
function FormatCreditCard($cc)
{    // Clean out extra data that might be in the cc
    $cc = str_replace(array('-',' '),'',$cc);
    // Get the CC Length
    $cc_length = strlen($cc);
    // Initialize the new credit card to contian the last four digits
    $newCreditCard = substr($cc,-4);
    // Walk backwards through the credit card number and add a dash after every fourth digit
    for($i=$cc_length-5;$i>=0;$i--){
        // If on the fourth character add a dash
        if((($i+1)-$cc_length)%4 == 0){
            $newCreditCard = '-'.$newCreditCard;
        }
        // Add the current character to the new credit card
        $newCreditCard = $cc[$i].$newCreditCard;
    }
    // Return the formatted credit card number
    return $newCreditCard;
}

//Setting the Api key of Stripe.
//Change it when setup to the live environment.
function get_api(){
	return "sk_test_cmi32OHLo1FuZ8RBKzBTvfPt";
}
?>